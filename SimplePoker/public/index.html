<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simple poker</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/7.14.2/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="/__/firebase/7.14.2/firebase-auth.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-database.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-messaging.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-storage.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-functions.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>
  <script defer src="./js/shared.js?cbust=38"></script>
  <script defer src="./js/poker.js?cbust=38"></script>
  <script defer src="./js/database-new.js?cbust=38"></script>

  <script>

    function outputHand(hand, combo) {
      var str = "";
      for (var i in hand) {
        str += hand[i].text + " ";
      }
      if (combo) {
        str += combo.combinationName;
      }
      return str;
    }

    function playerText(player) {
      if (player.theirTurn) {
        return "Player " + player.name + " is doing their turn";
      }
      if (player.drawSize == null) {
        return "Player " + player.name + " is waiting for their turn";
      }
      return "Player " + player.name + " exchanged " + player.drawSize + " cards";
    }

    function exchange() {
      var cards = [];
      for (var i = 0; i < 5; i++) {
        var checkbox = document.getElementById('xch' + i);
        if (checkbox.checked) {
          cards.push(i);
        }
      }
      exchangeCards(cards);
    }

    function renderGameInFlight(game) {
      var contents = "";
      // var yourTurn = false;
      // var yourHand = getHand(game, userId);
      for (i in game.players) {
        var player = game.players[i];
        if (i == game.myPosition) {
          contents += "<b>Your hand:</b> " + outputHand(game.myHand);
          if (player.theirTurn) {
            contents += "<span style='color:green'> Your turn</span>";
          }
        } else {
          contents += playerText(player);
        }
        contents += "<br/>";
      }
      if (game.players[game.myPosition].theirTurn) {
        contents += "<p/>Select cards to exchange:<br/>"
        contents += "<form>";
        for (var i in game.myHand) {
          contents += "<input type='checkbox' id='xch" + i + "' name='xch" + i + "'/>";
          contents += "<label for='xch" + i + "'>" + game.myHand[i].text;
          contents += "</label>";
        }
        contents +=
          "<input type='button' value='exchange' onclick='exchangeCardsUI();'/>" +
          "</form>";
      }
      return contents
    }

    function renderShowdown(game) {
      var str = "";
      for (i in game.players) {
        var playerInfo = game.players[i];
        if (i == game.myPosition) {
          str += "<b>Your hand:</b> "
        } else {
          str += "Player " + playerInfo.name + ":"
        }
        str += outputHand(playerInfo.hand, playerInfo.combination);
        if (playerInfo.result == PlayerResult.Win) {
          str += " wins";
        } else if (playerInfo.result == PlayerResult.Lose) {
          str += " loses";
        }
        str += "<br/>"
      }
      return str;
    }

    function renderWaiting(game, gid) {
      var str = "Waiting for more players to join. Game ID: " + gid;
      str += "<br/>Players so far:<ol>";
      for(var i in game.players) {
        str += "<li>"+game.players[i].name+"</li>";
      }
      str += "</ol>";
      return str;
    }


    function renderGame(game, gid) {
      if (!game || game.myPosition == null || !game.players) {
        return "No active games";
      }

      switch (game.status) {
        case GameState.WaitingForStart:
          return renderWaiting(game, gid);
        case GameState.WaitingForTurn:
          return renderGameInFlight(game);
        case GameState.Showdown:
            return renderShowdown(game);

      }
      return "Malformed game";
    }

    function renderPlayerInfo(playerInfo) {
      if (!playerInfo || !playerInfo.user || !playerInfo.user.uid) {
        document.getElementById('game').innerHTML = "Please login";
      } else {
        document.getElementById('name_input').value = playerInfo.user.name;
        document.getElementById('game').innerHTML = renderGame(
          playerInfo.currentGame, playerInfo.currentGameId);
      }
    }

    function resultCallback(result) {
      alert(JSON.stringify(result));
    }

    function updateUserInfoUI() {
      var newName = document.getElementById("name_input").value;
      if (globalPlayerInfo.user.uid && newName && newName != "") {
        updateUserInfo(globalPlayerInfo.user.uid, newName)
      }
    }
    function joinGameUI() {
      var gid = document.getElementById("gid_input").value.trim();
      if (gid && gid != "") {
        joinGame(gid, resultCallback);
      }
    }
    function dealUI() {
      deal(resultCallback);
    }
    function createGameUI() {
      createGame(resultCallback);
    }

    function exchangeCardsUI() {
      var cards = [];
      for (var i = 0; i < 5; i++) {
        var checkbox = document.getElementById('xch' + i);
        if (checkbox.checked) {
          cards.push(i);
        }
      }
      exchangeCards(cards, resultCallback);
    }
  </script>
</head>

<body>
  <div id="buttons">
    <form>
      <input type="button" value="login" onclick="login();" />
      Your name: <input id = "name_input" type="text" >
      <input type="button" value="Update name" onclick="updateUserInfoUI();" />
      <input type="button" value="Create new game" onclick="createGameUI();" /><br/>
      <input id = "gid_input" type="text" value="-MAxvpQ2xS426TOYzTS9">
      <input type="button" value="Join game" onclick="joinGameUI();" />
      <input type="button" value="Deal" onclick="dealUI();" />
    </form>
    <form id="users"></form>
    <p />
    <div id="game">
      No active games
      </form>
    </div>
    <p />
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        initWorld(renderPlayerInfo);
      });
    </script>
</body>

</html>
