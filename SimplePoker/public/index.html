<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simple poker</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/7.14.2/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="/__/firebase/7.14.2/firebase-auth.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-database.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-messaging.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-storage.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-functions.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>
  <script defer src="./js/shared.js?cbust=44"></script>
  <script defer src="./js/poker.js?cbust=44"></script>
  <script defer src="./js/database-new.js?cbust=44"></script>

  <script>

    function outputHand(hand, combo) {
      var str = "";
      for (var i in hand) {
        str += hand[i].text + " ";
      }
      if (combo) {
        str += combo.combinationName;
      }
      return str;
    }

    function lastTime(result) {
      if (result == PlayerResult.Win) {
        return " Won previous round";
      } else if (result == PlayerResult.Lose) {
        return " Lost previous round";
      }
      return "";
    }

    function playerText(player) {
      var playerLabel = player.isDealer ? "Dealer " : "Player ";
      var text;
      if (player.theirTurn) {
        text = playerLabel + player.name + " is doing their turn";
      } else if (player.drawSize == null) {
        text = playerLabel + player.name + " is waiting for their turn";
      } else {
        text = playerLabel + player.name + " exchanged " + player.drawSize +
            " cards";
      }
      return text +"." + lastTime(player.previousResult);
    }

    function renderGameInFlight(game) {
      var contents = "";
      // var yourTurn = false;
      // var yourHand = getHand(game, userId);
      for (i in game.players) {
        var player = game.players[i];
        if (i == game.myPosition) {
          if (player.isDealer) {
              contents += "[Dealer]";
          }
          contents += "<b>Your hand:</b> " + outputHand(game.myHand);
          if (player.theirTurn) {
            contents += "<span style='color:green'> Your turn</span>";
          }
          contents += lastTime(player.previousResult);
        } else {
          contents += playerText(player);
        }
        contents += "<br/>";
      }
      if (game.players[game.myPosition].theirTurn) {
        contents += "<p/>Select cards to exchange:<br/>"
        contents += "<form>";
        for (var i in game.myHand) {
          contents += "<input type='checkbox' id='xch" + i + "' name='xch" + i + "'/>";
          contents += "<label for='xch" + i + "'>" + game.myHand[i].text;
          contents += "</label>";
        }
        contents +=
          "<input type='button' value='exchange' onclick='exchangeCardsUI();'/>" +
          "</form>";
      }
      return contents
    }

    function renderShowdown(game) {
      var str = "";
      for (i in game.players) {
        var playerInfo = game.players[i];
        if (i == game.myPosition) {
          str += "<b>Your hand:</b> "
        } else {
          str += "Player " + playerInfo.name + ":"
        }
        str += outputHand(playerInfo.hand, playerInfo.combination);
        if (playerInfo.result == PlayerResult.Win) {
          str += " wins";
        } else if (playerInfo.result == PlayerResult.Lose) {
          str += " loses";
        }
        str += "<br/>"
      }
      return str;
    }

    function renderWaiting(game, gid) {
      var str = "Waiting for more players to join. Game ID: " + gid;
      str += "<br/>Players so far:<ol>";
      for(var i in game.players) {
        str += "<li>"+game.players[i].name+"</li>";
      }
      str += "</ol>";
      return str;
    }


    function renderGame(game, gid) {
      if (!game || game.myPosition == null || !game.players) {
        return "No active games";
        document.getElementById('dealButton').disabled = "disabled";
        document.getElementById('nextButton').disabled = "disabled";
      }
      var gameHtml;
      var deal = false;
      var next = false;

      switch (game.status) {
        case GameState.WaitingForStart:
          deal = game.players[game.myPosition].isDealer;
          gameHtml = renderWaiting(game, gid);
          break;
        case GameState.WaitingForTurn:
          gameHtml = renderGameInFlight(game);
          break;
        case GameState.Showdown:
          next = true;
          gameHtml = renderShowdown(game);
          break;
        default:
          gameHtml =  "Malformed game";
          break;
      }

      document.getElementById('dealButton').disabled = deal ? null : "disabled";
      document.getElementById('nextButton').disabled = next ? null : "disabled";
      return gameHtml;
    }

    function renderPlayerInfo(playerInfo) {
      if (!playerInfo || !playerInfo.user || !playerInfo.user.uid) {
        document.getElementById('game').innerHTML = "Please login";
        document.getElementById('dealButton').disabled = "disabled";
        document.getElementById('nextButton').disabled = "disabled";
      } else {
        document.getElementById('name_input').value = playerInfo.user.name;
        document.getElementById('game').innerHTML = renderGame(
          playerInfo.currentGame, playerInfo.currentGameId);
      }
    }

    function hideLoading() {
      document.getElementById("loading").style.display = "none";
    }

    function resultCallback(result) {
      hideLoading();
      if (result.error) {
        alert(JSON.stringify(result));
      } else {
        console.log("Callback result:" + JSON.stringify(result));
      }
    }

    function updateUserInfoUI() {
      var newName = document.getElementById("name_input").value;
      if (globalPlayerInfo.user.uid && newName && newName != "") {
        document.getElementById("loading").style.display = "inline";
        updateUserInfo(globalPlayerInfo.user.uid,
                       newName, /*email=*/ null, hideLoading);
      }
    }
    function joinGameUI() {
      if (globalPlayerInfo.currentGame &&
          globalPlayerInfo.currentGame.status != GameState.Showdown) {
        if (!confirm("Leave current game?")) {
          return;
        }
      }
      var gid = document.getElementById("gid_input").value.trim();
      if (gid && gid != "") {
        document.getElementById("loading").style.display = "inline";
        joinGame(gid, resultCallback);
      }
    }
    function dealUI() {
      document.getElementById("loading").style.display = "inline";
      deal(resultCallback);
    }
    function createGameUI() {
      if (globalPlayerInfo.currentGame &&
          globalPlayerInfo.currentGame.status != GameState.Showdown) {
        if (!confirm("Leave current game?")) {
          return;
        }
      }
      document.getElementById("loading").style.display = "inline";
      createGame(resultCallback);
    }

    function exchangeCardsUI() {
      var cards = [];
      for (var i = 0; i < 5; i++) {
        var checkbox = document.getElementById('xch' + i);
        if (checkbox.checked) {
          cards.push(i);
        }
      }
      document.getElementById("loading").style.display = "inline";
      exchangeCards(cards, resultCallback);
    }
    function nextRoundUI() {
      document.getElementById("loading").style.display = "inline";
      nextRound(resultCallback);
    }
  </script>
</head>

<body>
  <div id="buttons">
    <form>
      <input type="button" value="login" onclick="login();" />
      Your name: <input id = "name_input" type="text" >
      <input type="button" value="Update name" onclick="updateUserInfoUI();" />
      <input type="button" value="Create new game" onclick="createGameUI();" /><br/>
      <input id = "gid_input" type="text" value="-MAxvpQ2xS426TOYzTS9">
      <input type="button" value="Join game" onclick="joinGameUI();" />
      <input type="button" id = "dealButton" value="Deal" disabled = "disabled" onclick="dealUI();" />
      <input type="button" id = "nextButton" value="Another round" disabled = "disabled" onclick="nextRoundUI();" />
    </form>
    <p />
    <div id="game">
      No active games
    </div>
    <img id="loading" src="img/loading_wikimedia.gif" style="display:none;width:100px;height:100px">
    <p />
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        initWorld(renderPlayerInfo);
      });
    </script>
</body>

</html>
