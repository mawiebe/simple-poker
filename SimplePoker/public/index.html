<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simple poker</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/7.14.2/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="/__/firebase/7.14.2/firebase-auth.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-database.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-messaging.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-storage.js"></script>
  <script defer src="/__/firebase/7.14.2/firebase-functions.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>
  <script defer src="/js/shared.js?cbust=11"></script>
  <script defer src="/js/database.js?cbust=11"></script>
  <script defer src="/js/poker.js?cbust=11"></script>

  <script>
    function outputHand(hand, combo) {
      var str = "";
      for (var i in hand) {
        str += getCard(hand[i]).text + " ";
      }
      if (combo) {
        str += combo.combinationName;
      }
      return str;
    }

    function playerText(game, player, playersTurn) {
      var draw = game.draws ? game.draws[player.id] : null;
      if (playersTurn) {
        return "Player " + player.name + " is doing their turn";
      }
      if (!draw) {
        return "Player " + player.name + " is waiting for their turn";
      }
      return "Player " + player.name + " exchanged " + draw.length + " cards";
    }

    function exchange() {
      var cards = [];
      for (var i = 0; i < 5; i++) {
        var checkbox = document.getElementById('xch' + i);
        if (checkbox.checked) {
          cards.push(i);
        }
      }
      exchangeCards(cards);
    }

    function renderGameInFlight(game, userId) {
      var contents = "";
      var previousExchanged = true;
      var yourTurn = false;
      var yourHand = getHand(game, userId);
      for (i in game.players) {
        var player = game.players[i];
        var playerExchanged = game.draws && game.draws[player.id];
        var playersTurn = previousExchanged && !playerExchanged;
        if (player.id == userId) {
          contents += "<b>Your hand:</b> " + outputHand(yourHand);
          if (playersTurn) {
            yourTurn = true;
            contents += "<span style='color:green'> Your turn</span>";
          }
        } else {
          contents += playerText(game, player, playersTurn);
        }
        contents += "<br/>";
        previousExchanged = playerExchanged;
      }
      if (yourTurn) {
        contents += "<p/>Select cards to exchange:<br/>"
        contents += "<form>";
        for (var i in yourHand) {
          contents += "<input type='checkbox' id='xch" + i + "' name='xch" + i + "'/>";
          contents += "<label for='xch" + i + "'>" + getCard(yourHand[i]).text;
          contents += "</label>";
        }
        contents +=
          "<input type='button' value='exchange' onclick='exchange();'/>" +
          "</form>";
      }
      return contents
    }

    function renderGameResults(results, userId) {
      var str = "";
      for (i in results) {
        var playerInfo = results[i];
        if (playerInfo.id == userId) {
          str += "<b>Your hand:</b> "
        } else {
          str += "Player " + playerInfo.name + ":"
        }
        str += outputHand(playerInfo.hand, playerInfo.combo);
        if (playerInfo.wins) {
          str += " wins";
        }
        if (playerInfo.loses) {
          str += " loses";
        }
        str += "<br/>"
      }
      return str;
    }

    function getGameText(game) {
      if (!game) {
        return "No active games";
      }
      var userId = globalUser.uid;
      var results = getResults(game);
      if (results) {
        return renderGameResults(results, userId);
      }
      return renderGameInFlight(game, userId);
    }

    function renderGame() {
      if (!currentUserId) {
        document.getElementById('game').innerHTML = "Please login";
      } else {
        document.getElementById('game').innerHTML = getGameText(currentGame);
      }
    }

    function startTheGame() {
      if (selectedUsers.size <= 1) {
        console.error("Not enough players");
        return;
      }
      var players = [];
      for (user in selectedUsers) {
        players.push({
          id: user,
          name: allUsers[user].name
        });
      }
      startGame(players);
    }

    var selectedUsers = {};

    function updateSelection() {
      var selection = {};
      var count = 0;
      for (user in allUsers) {
        var checkbox = document.getElementById("u" + user);
        if (checkbox && checkbox.checked) {
          selection[user] = 1;
          count++;
        }
      }
      selectedUsers = selection;
      document.getElementById("start").disabled = (count > 1 ? null : "disabled");
    }

    function renderUsers() {
      if (allUsers == null) {
        return;
      }
      if (globalUser != null && allUsers[globalUser.uid]) {
        document.getElementById('user').innerHTML =
          "User: " + allUsers[globalUser.uid].name;
      }
      var contents = "";
      for (user in allUsers) {
        contents += "<input type='checkbox' id='u" + user + "' name='u" + user + "' ";
        if (selectedUsers[user]) {
          contents += "checked ";
        }
        contents += "onclick='updateSelection()'/>";

        contents += "<label for='u" + user + "'>" + allUsers[user].name + ", ";
        contents += allUsers[user].email;
        contents += "</label><br/>";
      }
      contents += '<input type="button" id="start" value="Start game" disabled onclick="startTheGame();" />';

      document.getElementById("users").innerHTML = contents;
    }
    function updateUserInfo() {
      if (globalUser) {
        firebase.database().ref(userInfoPath(globalUser.uid)).update({
          email: globalUser.email,
          name: globalUser.displayName,
        });
      }
    }
    function testCreateGame() {
      var createGame = firebase.functions().httpsCallable('createGame');
      createGame().then(function(result) {
        alert(JSON.stringify(result.data));
      });
    }
    function testJoinGame() {
      var game = document.getElementById("gid_input").value;
      var joinGame = firebase.functions().httpsCallable('joinGame');
      joinGame({gid: game}).then(function(result) {
        alert(JSON.stringify(result.data));
      });
    }
    function testStartGame() {
      var game = document.getElementById("gid_input").value;
      var startGame = firebase.functions().httpsCallable('startGame');
      startGame({gid: game}).then(function(result) {
        alert(JSON.stringify(result.data));
      });
    }
    function testExchangeCards() {
      var game = document.getElementById("gid_input").value;
      var exchangeCards = firebase.functions().httpsCallable('exchangeCards');
      exchangeCards({gid: game, discarded:[0, 3,4]}).then(function(result) {
        alert(JSON.stringify(result.data));
      });
    }
  </script>
</head>

<body>
  <p id="load">Firebase SDK Loading&hellip;</p>
  <div id="user">User: not logged in</div>
  <div id="buttons" style="display:none">
    <form>
      <input type="button" value="login" onclick="login();" />
      <input type="button" value="test new write user data" onclick="updateUserInfo();" />
      <input type="button" value="test new create game" onclick="testCreateGame();" /><br/>
      <input id = "gid_input" type="text" value="-MAxvpQ2xS426TOYzTS9">
      <input type="button" value="test new join game" onclick="testJoinGame();" />
      <input type="button" value="test new start game" onclick="testStartGame();" />
      <input type="button" value="test new exchange" onclick="testExchangeCards();" />
    </form>
    <form id="users"></form>
    <p />
    <div id="game">
      No active games
      </form>
    </div>
    <p />
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥
        // // The Firebase SDK is initialized and available here!
        //
        firebase.auth().onAuthStateChanged(user => {
          globalUser = user;
          if (checkUser()) {
            renderUsers();
          } else {
            document.getElementById('user').innerHTML = "User: " + user.email;
          }
          changeUser(user.uid);
        });
        // firebase.database().ref('/path/to/ref').on('value', snapshot => { });
        // firebase.messaging().requestPermission().then(() => { });
        // firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
        //
        // // ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥

        try {
          let app = firebase.app();
          document.getElementById('load').remove();
          document.getElementById('buttons').style.display = 'block';
          listUsers();
        } catch (e) {
          console.error(e);
          document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';
        }
      });
    </script>
</body>

</html>
